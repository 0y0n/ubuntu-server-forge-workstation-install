# =============================================================================
# roles/kvm/tasks/main.yml
# 1) Install QEMU / libvirt / virt-manager
# 2) Generate an SSH keypair for guest access
# 3) Download Ubuntu cloud image (cached)
# 4) Provision dev-workstation VM
# 5) Provision forge-infra VM
# 6) Wait until both VMs expose SSH on the mapped host ports
# =============================================================================
---
# ── packages ─────────────────────────────────────────────────────────────────
- name: "kvm | install virtualisation stack"
  become: true
  ansible.builtin.apt:
    name:
      - qemu-kvm
      - libvirt-daemon-system
      - libvirt-clients
      - virt-manager
      - virtinst            # virt-install CLI
      - cloud-init
      - nmap                # for portcheck in wait task
      - cloud-image-utils
      - xorriso
      - python3-lxml
      - python3-libvirt      
      - libnss-libvirt
    state: present
    update_cache: true

- name: "kvm | enable & start libvirtd"
  become: true
  ansible.builtin.systemd:  
    name:    libvirtd
    enabled: true
    state:   started

- name: "kvm | add current user to libvirt group"
  ansible.builtin.user:
    name:   "{{ ansible_facts['user_id'] }}"
    groups: libvirt
    append: true

- name: "kvm | configure nsswitch to use libvirt dns"
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^hosts: '
    line: 'hosts:          files libvirt dns'
  become: true

# ── SSH key ──────────────────────────────────────────────────────────────────
- name: "kvm | generate SSH keypair for VM guests"
  community.crypto.openssh_keypair:
    path: "{{ forge_ssh_key }}"
    type: ed25519
    state: present
    owner: "{{ ansible_facts['user_id'] }}"
    mode: '0600'
  register: ssh_key_result

- name: "kvm | set pubkey fact"
  ansible.builtin.set_fact:
    forge_pubkey: "{{ ssh_key_result.public_key }}"

# ── cloud image ──────────────────────────────────────────────────────────────
- name: "kvm | ensure vm-images directory"
  ansible.builtin.file:
    path:  "{{ forge_vm_images }}"
    state: directory
    mode:  "0755"

- name: "kvm | download Ubuntu cloud image (cached)"
  ansible.builtin.get_url:
    url:  "{{ ubuntu_cloud_image_url }}"
    dest: "{{ forge_vm_images }}/server-cloudimg-amd64.img"
    mode: "0644"

# ── provision helper (imported per-VM) ───────────────────────────────────────
- name: "kvm | provision dev-workstation"
  ansible.builtin.include_tasks: provision_vm.yml
  vars:
    vm: "{{ vm_dev_workstation }}"

- name: "kvm | provision forge-infra"
  ansible.builtin.include_tasks: provision_vm.yml
  vars:
    vm: "{{ vm_forge_infra }}"
